# SERフォーマット関連

## 概要
動画のフレーム確認ソフト
SER形式の動画形式のファイルのフレームとタイムスタンプを確認するソフトウェアです。

## 参照資料
SER Format Description Version 3:
[https://free-astro.org/images/5/51/SER_Doc_V3b.pdf](https://free-astro.org/images/5/51/SER_Doc_V3b.pdf)

## ファイルについて
拡張子：ser

## 構造
ファイルの先頭にヘッダーが178byteあります。
ヘッダ情報に基づいたサイズの画像データがフレーム数分つづきます。
画像の1フレームあたりのバイトサイズは、 `幅 x 高さ x (ピクセル深度に応じたバイト数) x (色形式に応じたプレーン数)` となります。
ファイルの末尾に、タイムスタンプトレーラーがある場合があります (詳細はDateTimeヘッダーを参照)。

### ヘッダ
ヘッダー内の数値フィールド (LuID, ColorID, LittleEndian, 幅, 高さ, ビット数, フレーム数, DateTime, DateTimeUTC) はリトルエンディアンで格納されます。
テキストフィールド (FileID, Observer, Instrumenta, Telescope) はASCII文字列です。

ファイルID：14byte (固定文字列 "LUCAM-RECORDER")
LuID：4byte 整数 (Lumenera camera ID, 現在未使用)
ColorID：4byte 整数 (カラーフォーマットを示すID)
    - MONO = 0
    - BAYER_RGGB = 8
    - BAYER_GRBG = 9
    - BAYER_GBRG = 10
    - BAYER_BGGR = 11
    - BAYER_CYYM = 16
    - BAYER_YCMY = 17
    - BAYER_YMCY = 18
    - BAYER_MYYC = 19
    - RGB = 100
    - BGR = 101
LittleEndian：4byte 整数 (16bit画像データのバイトオーダーを指定)
    - 0: Big-Endian
    - 1: Little-Endian (ヘッダー自体のエンディアンとは別)
幅：4byte 整数 (画像の幅 ピクセル)
高さ：4byte 整数 (画像の高さ ピクセル)
ビット数 (PixelDepthPerPlane)：4byte 整数 (1プレーンあたりのビット深度)
フレーム数 (FrameCount)：4byte 整数 (ファイル内の総フレーム数)
Observer：40byte テキスト (観測者名、未使用はNULL埋め)
Instrumenta：40byte テキスト (カメラ名、未使用はNULL埋め)
Telescope：40byte テキスト (望遠鏡名、未使用はNULL埋め)
DateTime：8byte 整数 (Ticks形式、記録開始時刻の**ローカルタイム**)
    - **重要:** この値が `0` 以下の場合、タイムスタンプトレーラーは存在しないか無効です。
DateTimeUTC：8byte 整数 (Ticks形式、記録開始時刻の**UTC**)

### 画像データ
サイズ： `幅 x 高さ x (ピクセル深度に応じたバイト数) x (色形式に応じたプレーン数)`
各情報はヘッダに描かれています。
オフセット： ヘッダー(178byte)の後から始まります。
データ構造：
- 1-8bit: 1バイト/ピクセル/プレーン
- 9-16bit: 2バイト/ピクセル/プレーン
- RGB/BGR (ColorID=100/101): 3プレーン
- MONO/BAYER: 1プレーン

### トレーラー
**DateTimeヘッダー値が正の場合のみ存在します。**
8byteのタイムスタンプ (Ticks形式, UTC) がフレーム数分あります。
オフセット: ヘッダー(178byte) + 全画像データ の後から始まります。

### DateTime / DateTimeUTC / トレーラーのタイムスタンプ (Ticks形式)
「グレゴリオ暦の西暦1年1月1日の始まりから経過した時間を100ナノ秒単位で表す、IEEE 64ビット（8バイト）の値を保持します。
これにより、西暦1年1月1日から西暦9999年12月31日までの日付と、午前0時（深夜）から午後11時59分59秒9999999までの時刻を表現できます。
各増分は100ナノ秒の経過時間を表します。最大値は、西暦10000年1月1日の始まりの100ナノ秒前を表します。」

## SER_Info.py の使い方
作成した `SER_Info.py` スクリプトを使用して、SERファイルのヘッダー情報とトレーラー（タイムスタンプ）を表示できます。

### 基本的な使い方
```bash
python SER_Info.py <ser_file_path>
```
`<ser_file_path>` には、確認したいSERファイルのパスを指定します。
デフォルトでは、タイムスタンプが多数ある場合、最初と最後の5件のみが表示されます。

### オプション
*   `-a`, `--all-timestamps`:
    このオプションを付けて実行すると、トレーラーに含まれる全てのタイムスタンプが表示されます。
    ```bash
    python SER_Info.py -a <ser_file_path>
    ```
*   `-o`, `--show-offsets`:
    このオプションを付けて実行すると、各タイムスタンプの後ろに、対応する画像データのファイル先頭からの開始オフセット（16進数）が表示されます。
    ```bash
    python SER_Info.py -o <ser_file_path>
    ```
    `-a` オプションと同時に指定することも可能です。

## SER_Frame_Viewer.py の使い方
`SER_Frame_Viewer.py` スクリプトを使用して、SERファイル内の指定されたフレーム画像を表示し、関連情報やヒストグラムを出力できます。
**注意:** このスクリプトは `numpy`, `Pillow`, `matplotlib` ライブラリが必要です。
```bash
pip install numpy Pillow matplotlib
```

### 基本的な使い方
```bash
python SER_Frame_Viewer.py <ser_file_path> <frame_number>
```
*   `<ser_file_path>`: 表示したいSERファイルのパスを指定します。
*   `<frame_number>`: 表示したいフレームの番号を1から始まる整数で指定します。

実行すると、指定されたフレームの画像が表示され、ターミナルにはピクセル値の最小/最大値などの情報が出力されます。

### オプション
*   `-hist`, `--histogram`:
    ピクセル値（カラー画像の場合は輝度）のヒストグラムを別ウィンドウで表示します。
    ```bash
    python SER_Frame_Viewer.py <ser_file_path> <frame_number> -hist
    ```
*   `--clip-low PERCENT`:
    画像表示時の明るさ範囲の下限を、ピクセル値全体の下位 `PERCENT` パーセンタイル値に設定します。デフォルトは `0.0`。
    例 (下位1%をクリップ): `python SER_Frame_Viewer.py ... --clip-low 1.0`
*   `--clip-high PERCENT`:
    画像表示時の明るさ範囲の上限を、ピクセル値全体の上位 `PERCENT` パーセンタイル値に設定します。デフォルトは `100.0`。
    例 (上位0.5%をクリップ): `python SER_Frame_Viewer.py ... --clip-high 99.5`
*   `--force-endian {little|big}`:
    16bit画像データのエンディアン（バイトオーダー）を強制的に指定します。ヘッダーの `LittleEndian` フラグが信用できない場合に使用します。

## SER_Interactive_Viewer.py の使い方
`SER_Interactive_Viewer.py` スクリプトを使用すると、SERファイル内のフレームをインタラクティブに切り替えて表示できます。
**注意:** このスクリプトは `numpy`, `Pillow`, `matplotlib` ライブラリが必要です。
```bash
pip install numpy Pillow matplotlib
```

### 基本的な使い方
```bash
python SER_Interactive_Viewer.py <ser_file_path> [オプション...]
```
*   `<ser_file_path>`: 表示したいSERファイルのパスを指定します。

実行すると、最初のフレームが表示されたウィンドウが開きます。キーボードの矢印キーでフレームを移動できます。

### オプション
*   `--start-frame FRAME`:
    最初に表示するフレーム番号を **1** から始まる整数で指定します。デフォルトは `1`。
*   `--clip-low PERCENT`:
    画像表示時の明るさ範囲の下限を、ピクセル値全体の下位 `PERCENT` パーセンタイル値に設定します。デフォルトは `0.0`。
*   `--clip-high PERCENT`:
    画像表示時の明るさ範囲の上限を、ピクセル値全体の上位 `PERCENT` パーセンタイル値に設定します。デフォルトは `100.0`。
*   `--force-endian {little|big}`:
    16bit画像データのエンディアン（バイトオーダー）を強制的に指定します。ヘッダーの `LittleEndian` フラグが信用できない場合に使用します。

### キーボード操作
*   `←` (左矢印キー): 前のフレームへ移動します (最初のフレームで押すと最後のフレームへループします)。
*   `→` (右矢印キー): 次のフレームへ移動します (最後のフレームで押すと最初のフレームへループします)。
*   `Shift + ←/→`: 10フレーム移動します。
*   `Ctrl + ←/→`: 100フレーム移動します。
*   `Alt + ←/→`: 1000フレーム移動します。
*   `↑` (上矢印キー): **(16bitファイルのみ)** 表示するビット範囲を上位方向に移動します (例: bits 7-0 → 8-1 → ... → 15-8)。タイトルに表示されるビット範囲が変わります。
*   `↓` (下矢印キー): **(16bitファイルのみ)** 表示するビット範囲を下位方向に移動します (例: bits 15-8 → 14-7 → ... → 7-0)。タイトルに表示されるビット範囲が変わります。
*   `q` または `Esc`: ビューアを終了します。

## SER_Stacker.py の使い方 (開発中)
`SER_Stacker.py` スクリプトは、SERファイル内のフレームをインタラクティブに表示し、ダークフレーム補正やスタック処理を行うツールです。表示には OpenCV ライブラリを使用します。
**注意:** このスクリプトは `numpy`, `opencv-python`, `astropy` ライブラリが必要です。画面サイズ取得のために `tkinter` も使用します。
```bash
pip install numpy opencv-python astropy
```

### 基本的な使い方
```bash
python SER_Stacker.py <ser_file_path> [オプション...]
```
*   `<ser_file_path>`: 処理したいSERファイルのパスを指定します。

実行すると、6つのウィンドウが表示されます。

### 画面レイアウト
*   **上段左 (SER Viewer):** 現在のフレーム画像（ダーク減算後）を表示します。タイトルにはフレーム番号、表示ビットシフト、ダーク情報、現在のスタック設定（例: `Stack: 1-10f/10f avg`）が表示されます。
*   **上段中央 (Log Messages / Dark Preview/Select):**
    *   **View / Stack Config モード時:** 操作ログメッセージを表示します。
    *   **Dark Select モード時:** FITSファイルリストまたは選択中のダークファイルのプレビューを表示します。
*   **上段右 (Debayered):** 現在のフレームをデベイヤーした画像（ダーク減算後）を表示します (Bayerパターン時のみ)。
*   **下段左 (Stack (Raw)):** スタック結果（ダーク減算**前**）を表示します (スタック実行後)。
*   **下段中央 (Stack (Dark Subtracted)):** スタック結果（ダーク減算**後**）を表示します (スタック実行後)。
*   **下段右 (Debayered Stack):** 下段中央のスタック結果をデベイヤーした画像を表示します (スタック実行後、Bayerパターン時のみ)。

### オプション
*   `--start-frame FRAME`:
    最初に表示するフレーム番号を **1** から始まる整数で指定します。デフォルトは `1`。
*   `--clip-low PERCENT`:
    **上段の**表示範囲の下限を、ビットシフト後の8bitデータ全体の下位 `PERCENT` パーセンタイル値に設定します。デフォルトは `0.0`。
*   `--clip-high PERCENT`:
    **上段の**表示範囲の上限を、ビットシフト後の8bitデータ全体の上位 `PERCENT` パーセンタイル値に設定します。デフォルトは `100.0`。
*   `--force-endian {little|big}`:
    16bit画像データのエンディアン（バイトオーダー）を強制的に指定します。ヘッダーの `LittleEndian` フラグが信用できない場合に使用します。
*   `--ser-player-compat`:
    SER Player 互換モードを有効にします。このオプションを指定すると、`w` キーで移動平均スタックをSERファイルとして保存する際に、ヘッダーの `LittleEndian` フラグが `0` (Big Endianを示す) に設定されます（実際のデータは Little Endian のままです）。特定のビューア（例: SER Player）での表示互換性のために使用します。デフォルトは無効（フラグは `1`）。

### モード
`Tab` キーで以下のモードを順番に切り替えます (`View` -> `Dark Select` -> `Stack Config` -> `Align Config` -> `View`)。ウィンドウタイトル左上に現在のモードが表示されます。
1.  **View:** 通常のフレーム表示モード。フレーム移動、ビットシフト調整、ダーク操作用ビットシフト調整が可能です。
2.  **Dark Select:** ダークフレーム選択モード。FITS ファイルリストからダークフレームを選択・適用・解除できます。
3.  **Stack Config:** スタック設定モード。スタックするフレーム数と演算方法を設定し、スタックを実行できます。
4.  **Align Config:** 位置合わせ設定モード。位置合わせの有効/無効、基準フレーム、ROIを設定できます。

### キーボード操作 (全モード共通)
*   `Tab`: モードを切り替えます (`View` -> `Dark Select` -> `Stack Config` -> `Align Config` -> `View`)。
*   `B`: 下段のスタック結果表示の正規化モードを `Bitshift` -> `Auto` -> `Fixed` -> `Bitshift` の順でトグルします。ウィンドウタイトルに `[Bitshift]`, `[Auto]` または `[Fixed]` が表示されます。
    *   `Bitshift`: Viewモードと同じビットシフト (Bits:) を適用して表示します。
    *   `Auto`: ZScaleまたはパーセンタイルクリップで自動調整して表示します。
    *   `Fixed`: 0-65535 の固定範囲で表示します。
*   `S`: **(移動平均)スタック結果**をSERファイルとして保存します。ダーク減算前 (`_raw_running`) と減算後 (`_darks_running`、ダーク適用時のみ) の両方が保存されます。ファイルは**複数フレーム** (入力総フレーム数 - スタックフレーム数 + 1 フレーム) となり、ファイル名には演算方法とスタック数 (例: `_avg5f_`) が含まれます。エンディアンはデフォルトで Little Endian (ヘッダーフラグ `1`) ですが、`--ser-player-compat` オプション指定時はヘッダーフラグが `0` になります。ファイル名の末尾に `_running` が付き、移動平均スタックであることを示します。
*   `W`: 現在の**単一**スタック結果を保存します。ダーク減算前 (`_raw`) と減算後 (`_darks`) の両方の **FITS データ (.fts)** と、現在表示されている**プレビュー画像 (.png)** が保存されます。ファイル名にはスタック範囲 (例: `_stack1-10f_`) が含まれます。末尾に `_preview` が付き、プレビュー画像であることを示します。
*   `Q` または `Esc`: 終了します。

### ファイル名のサフィックスについて
*   `_running.ser`: `s` キーで保存されるSERファイルに付与され、これが単一フレームのスタックではなく、**移動平均スタック**の結果であることを示します。
*   `_preview.png`: `w` キーで保存されるPNGファイルに付与され、これがFITSデータそのものではなく、表示用に**正規化・8bit化されたプレビュー画像**であることを示します。

### キーボード操作 (View モード)
*   `j` (左): 1 フレーム戻ります。
*   `k` (右): 1 フレーム進みます。
*   `Shift + j/k`: 10 フレーム移動します。
*   `Ctrl + j/k`: 100 フレーム移動します。
*   `h`/`l`: 1000 フレーム移動します (h: 戻る, l: 進む)。
    *   **注意:** フレーム移動した場合、スタック結果が計算済みであれば、新しいフレーム位置でスタックが自動的に再計算されます。
*   `i` (上): **(16bitのみ)** 上段ウィンドウの**表示用**ビットシフトを増やします。
*   `m` (下): **(16bitのみ)** 上段ウィンドウの**表示用**ビットシフトを減らします。
*   `[` (左角括弧): **(ダーク適用時のみ)** ダークフレームの**計算用**ビットシフトを **1 増やします** (最大8)。ダーク減算処理に影響します。
*   `]` (右角括弧): **(ダーク適用時のみ)** ダークフレームの**計算用**ビットシフトを **1 減らします** (最小0)。ダーク減算処理に影響します。

### キーボード操作 (Dark Select モード)
*   `i` / `m`: FITSファイルリストの選択カーソルを上下に移動します。
*   `k` (右): 選択中の FITS ファイルのプレビューを**上段中央**のウィンドウに表示します。
*   `j` (左): プレビュー表示を終了し、ファイルリストに戻します。
*   `Enter`: 選択中の FITS ファイルをダークフレームとして適用します (画像サイズが一致する場合)。
*   `D`: 適用中のダークフレームを解除します。

### キーボード操作 (Stack Config モード)
*   `j` (左): スタックするフレーム数を増やします。
*   `k` (右): スタックするフレーム数を減らします。
*   `Shift + j/k`: スタック数を 10 増減します。
*   `Ctrl + j/k`: スタック数を 100 増減します。
*   `h`/`l`: スタック数を 1000 増減します (h: 増やす, l: 減らす)。
    *   **注意:** スタック数は 1 ～ 総フレーム数の範囲に制限されます。
*   `i` / `m`: スタック演算 (`avg`, `sum`, `max`, `min`) を上下に切り替えます。
*   `Enter`: 現在の設定でスタック計算を実行し、下段ウィンドウに結果を表示します。

### キーボード操作 (Align Config モード)
*   `j` / `k`: フレームを移動します（`View` モードと同様）。
*   `Shift`/`Ctrl`/`h`/`l` + `j`/`k`: フレームを大きく移動します（`View` モードと同様）。
*   `e`: 位置合わせ機能の有効/無効をトグルします。タイトルバーの `Align: ON/OFF` で状態を確認できます。
*   `Enter`: **現在表示しているフレーム**を位置合わせの**基準フレーム**として設定します。
*   **マウスドラッグ:** メインウィンドウ (左上) 上でマウスをドラッグすることで、位置合わせに使用する **ROI (Region of Interest)** を選択します。ROIは、白い枠として表示されます。
*   `D`: 位置合わせ設定（有効/無効状態、基準フレーム、ROI）を**すべてリセット**します。

## 位置合わせ (アライメント) のノウハウ
`SER_Stacker.py` の位置合わせ機能は、スタック時のフレーム間のズレを補正し、よりシャープな結果を得るためのものです。以下の点を理解しておくと、より効果的に使用できます。

*   **アルゴリズム:** 現在は `cv2.matchTemplate` (テンプレートマッチング) を使用しています。基準フレームの ROI (テンプレート) を、各フレームの検索領域内で探し、最も一致する場所を見つけてズレ量を計算します。
*   **ROIの選択:**
    *   **重要:** 位置合わせの精度は、選択した ROI に**大きく依存**します。
    *   ROI 内には、フレーム間で**変化が少なく、かつ特徴的なパターン**（例: 明るく飽和していない星、輝度差のはっきりした模様など）を含めるようにしてください。
    *   ROI が小さすぎたり、平坦でのっぺりした領域だったり、逆に広すぎて複数の動く特徴を含んでしまうと、精度が低下する可能性があります。
    *   適切な ROI サイズは対象やズレの大きさによりますが、まずは 64x64 や 128x128 ピクセル程度の大きさから試してみてください。
*   **前処理とビットシフトの影響:** 位置合わせ計算 (`matchTemplate`) は、生データに対して直接行われるのではなく、以下の前処理を経た **8bit グレースケール画像**に対して行われます。
    1.  **ダーク減算 (適用時):** ダークフレームが適用されている場合、まず元データからダークフレーム（計算用ビットシフト適用後）が減算されます。これにより、ホットピクセル等のノイズの影響を低減し、精度向上が期待できます。
    2.  **表示用ビットシフト:** View モードで設定されている現在のビットシフト (`self.bit_shift`) を適用し、8bitに変換します。これにより、低コントラストな特徴が強調され、マッチング精度が向上します。
    3.  **グレースケール化:** カラーデータの場合はグレースケールに変換します。
    *   **注意点:** View モードで表示用ビットシフトを変更すると、マッチングに使われる画像の特徴が変わるため、位置合わせの精度に影響が出る可能性があります。ROI を選択・基準フレームを設定したら、スタック完了までビットシフトは変更しない方が安定するかもしれません。
*   **Bayerデータ:** Bayer パターンの SER ファイルの場合、色情報を壊さずに位置合わせを行うため、計算されたシフト量は**最も近い偶数ピクセルに丸められて**から適用されます。これにより、サブピクセル単位での精密な位置合わせは犠牲になりますが、色ずれを防ぐことができます。
*   **検索領域:** テンプレートマッチングの検索は、ROI の位置を中心として上下左右に 256 ピクセルずつ拡大した領域内で行われます。もしフレーム間のズレがこれより大きい場合は、正しく追従できない可能性があります。
*   **限界:** シーイングの変動が激しい場合や、回転ズレが大きい場合、この単純な平行移動による位置合わせでは限界があります。

# FITSフォーマット関連

## 概要 (FITS)
FITS (Flexible Image Transport System) は、主に天文学で使用されるデジタルファイル形式です。科学的な画像データ、テーブルデータ、およびそれらに関連するメタデータ（ヘッダー情報）を格納するために設計されています。拡張性があり、様々な種類のデータを格納できます。

## 構造 (FITS)
FITS ファイルは、1つ以上の **HDU (Header/Data Unit)** から構成されます。
*   **Primary HDU:** ファイルの最初に必ず存在する HDU です。画像データを含むことも、含まないこともあります（ヘッダーのみの場合）。
*   **Extension HDU:** Primary HDU の後に続く、任意の数の拡張 HDU です。画像データ (`ImageHDU`) やテーブルデータ (`BinTableHDU`, `TableHDU`) などを格納できます。

各 HDU は以下の要素から構成されます。
1.  **ヘッダー (Header):** ASCII テキスト形式で、キーワードと値のペアで構成され、データに関する情報（次元、データ型、観測情報など）を記述します。ヘッダーは `END` キーワードで終了します。
2.  **データ (Data):** ヘッダーで記述された形式に従うデータ配列（画像やテーブルなど）です。データ部は存在しないこともあります。

## ヘッダー (FITS)
FITS ヘッダーは、80文字固定長の ASCII レコード（カードイメージ）の集まりです。各レコードは通常、`キーワード = 値 / コメント` の形式で記述されます。
*   **キーワード:** 8文字以内の大文字英数字とハイフン、アンダースコア。
*   **値:** キーワードに対応するデータ。数値、文字列、論理値などがあります。
*   **コメント:** スラッシュ (`/`) 以降はコメントとして扱われます。

いくつかの **必須キーワード (Mandatory Keywords)** が Primary HDU ヘッダーの先頭に存在する必要があります。
*   `SIMPLE`: FITS 標準に準拠しているかを示す論理値 (`T`)。
*   `BITPIX`: データ配列の各要素のビット数（例: `8`, `16`, `32`, `-32` (float), `-64` (double)）。
*   `NAXIS`: データ配列の次元数（0 ならデータ部なし）。
*   `NAXISn`: 各次元の要素数 (n は 1 から `NAXIS` まで)。例: `NAXIS1`=幅, `NAXIS2`=高さ。
*   `END`: ヘッダーの終わりを示すキーワード。

これらに加えて、天体の名前 (`OBJECT`)、観測日時 (`DATE-OBS`)、露出時間 (`EXPTIME`)、使用機材 (`INSTRUME`, `TELESCOP`) など、多くの **予約済みキーワード (Reserved Keywords)** や、ユーザー定義のキーワードが使用されます。

## FITS_Viewer.py の使い方
`FITS_Viewer.py` スクリプトは、FITS (Flexible Image Transport System) 形式のファイルを OpenCV を使用してインタラクティブに表示します。
主な機能は以下の通りです。
*   指定された FITS ファイルを開き、最初に見つかった画像データを含む HDU (Header/Data Unit) を表示します（`--hdu` オプションで指定も可能）。
*   画像の表示には、デフォルトで ZScale アルゴリズムを用いた自動ストレッチ、またはパーセンタイルクリップによる正規化を行います。
*   16bit 以上の整数データの場合、表示する8bitの範囲をキーボードで1bitずつシフトできます。
*   FITS ヘッダー情報に基づき、または手動指定により、Bayer パターンを認識し、デベイヤー処理されたカラー画像を別ウィンドウに表示できます。

**注意:** このスクリプトは `numpy`, `opencv-python`, `astropy` ライブラリが必要です。任意で画面サイズ取得のために `tkinter` も使用します。
```bash
pip install numpy opencv-python astropy # tkinterは通常Pythonに付属
```

### 基本的な使い方
```bash
python FITS_Viewer.py <fits_file_path> [オプション...]
```
*   `<fits_file_path>`: 表示したい FITS ファイルのパスを指定します。

実行すると、メインのビューアウィンドウが表示されます。
`--debayer` オプションが指定され、Bayer パターンが認識された場合、デベイヤー処理されたカラー画像を表示する2つ目のウィンドウも表示されます。

### オプション
*   `--hdu INDEX`:
    表示する HDU のインデックスを **0** から始まる整数で指定します。デフォルトでは、最初に見つかった画像データを持つ HDU が自動的に選択されます。
*   `--clip-low PERCENT`:
    表示範囲の下限を、データ全体（またはビットシフト表示時は8bitデータ）の下位 `PERCENT` パーセンタイル値に設定します。デフォルトは `0.5`。ZScale アルゴリズム使用時は無視されます。
*   `--clip-high PERCENT`:
    表示範囲の上限を、データ全体（またはビットシフト表示時は8bitデータ）の上位 `PERCENT` パーセンタイル値に設定します。デフォルトは `99.5`。ZScale アルゴリズム使用時は無視されます。
*   `--normalize {auto|zscale|percentile|minmax|none}`:
    表示画像の正規化方法を指定します。デフォルトは `auto` (BITPIX > 0 なら zscale、それ以外なら minmax)。
*   `--cmap COLORMAP`:
    モノクロ画像表示に使用するカラーマップ名を指定します (例: `gray`, `viridis`, `magma`)。matplotlib で利用可能な名前が使えます。デフォルトは `gray`。
*   `--debayer [PATTERN]`:
    デベイヤー処理を強制します。オプションで Bayer パターン (`RGGB`, `GRBG`, `GBRG`, `BGGR`) を指定できます。パターンが指定されない場合、FITS ヘッダー (`BAYERPAT`) から読み取るか、デフォルト (`RGGB`) を使用します。
*   `--force-endian {little|big}`:
    16bit 以上の整数データのエンディアンを強制します。FITS では通常 Big-Endian ですが、互換性のために必要になる場合があります。

### キーボード操作
*   `←` / `→`: `--hdu` で指定された範囲内で前後の HDU に移動します（データが画像の場合のみ）。
*   `↑` / `↓`: **(16bit以上の整数データのみ)** 表示ビット範囲をシフトします。
*   `[` / `]`: 表示の下限/上限パーセンタイル（`--clip-low`/`--clip-high`）を微調整します (ZScale 使用時は無効)。
*   `n`: 正規化方法を `auto`/`zscale`/`percentile`/`minmax`/`none` の間で切り替えます。
*   `c`: カラーマップを `gray`/`viridis`/`magma`/`plasma` の間で切り替えます。
*   `b`: デベイヤー処理の ON/OFF を切り替えます（可能な場合）。
*   `p`: デベイヤーパターン (`RGGB`, `GRBG`, `GBRG`, `BGGR`) を切り替えます（デベイヤー ON 時）。
*   `q` または `Esc`: 終了します。

## FITS_Calc.py の使い方
`FITS_Calc.py` スクリプトは、2つのFITSファイルを入力とし、それらの間で基本的な画像演算（加算、減算、乗算、除算）を行い、結果を新しいFITSファイルとして保存します。また、入力画像と演算結果をインタラクティブに表示・比較できます。

**注意:** このスクリプトは `numpy`, `opencv-python`, `astropy` ライブラリが必要です。
```bash
pip install numpy opencv-python astropy
```

### 基本的な使い方
```bash
python FITS_Calc.py <input1.fits> <operation> <input2.fits> = <output.fts> [オプション...]
```
*   `<input1.fits>`: 1番目の入力FITSファイル。
*   `<operation>`: 実行する演算子 (`+`, `-`, `*`, `/`)。
*   `<input2.fits>`: 2番目の入力FITSファイル。
*   `=` : 出力ファイル指定の区切り文字。
*   `<output.fts>`: 演算結果を保存するFITSファイル名。

実行すると、3つのウィンドウ（入力1、入力2、演算結果）が表示され、インタラクティブな操作が可能になります。

### オプション
*   `--hdu1 INDEX`, `--hdu2 INDEX`:
    入力1、入力2それぞれで使用する HDU のインデックスを **0** から始まる整数で指定します。デフォルトは自動選択。
*   `--debayer1 [PATTERN]`, `--debayer2 [PATTERN]`:
    入力1、入力2それぞれに対してデベイヤー処理を強制します。オプションで Bayer パターンを指定できます。
*   `--normalize {auto|zscale|percentile|minmax|none}`:
    入力画像の初期表示正規化方法を指定します。デフォルトは `auto`。

### インタラクティブ操作 (ウィンドウ表示中)
*   `↑` / `↓`: **(16bit以上の入力のみ)** 両方の入力画像ウィンドウの表示ビット範囲を同時にシフトします。
*   `n`: 両方の入力画像ウィンドウの正規化方法を切り替えます。
*   `b`: (デベイヤー可能な入力に対し) デベイヤー ON/OFF を切り替えます。
*   `p`: (デベイヤー ON 時) デベイヤーパターンを切り替えます。
*   `Esc` または `q`: 表示を終了し、**演算結果を保存せずに終了**します。
*   `Enter`: 表示を終了し、**演算結果を指定されたファイル名で保存**します。